require "benchmark"
require 'date'
require 'mongo'
require  'csv'


# lista_hashes = [{:cnpj_basico=>107225, :cnpj_ordem=>1, :cnpj_dv=>23, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>20081231, :motivo_situao_cadastral=>71, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19720504, :cnae_fiscal_principal=>4781400, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"", :logradouro=>"QNM  09 LOTE", :numero=>27, :complemento=>"CONJ C", :bairro=>"CEILANDIA", :cep=>72237100, :uf=>"DF", :municipio=>9701, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>17120353, :cnpj_ordem=>1, :cnpj_dv=>28, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>20081231, :motivo_situao_cadastral=>71, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19721003, :cnae_fiscal_principal=>4712100, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"VILA", :logradouro=>"PALMEIRA", :numero=>"S N", :complemento=>"", :bairro=>"SACRAMENTO", :cep=>36900000, :uf=>"MG", :municipio=>4787, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>57744732, :cnpj_ordem=>1, :cnpj_dv=>3, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>4, :data_situao_cadastral=>20181023, :motivo_situao_cadastral=>63, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19870702, :cnae_fiscal_principal=>8130300, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"RUA", :logradouro=>"COIMBRA", :numero=>60, :complemento=>"", :bairro=>"BRAS", :cep=>807960, :uf=>"SP", :municipio=>7107, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>9227562.0, :cnpj_ordem=>1, :cnpj_dv=>47, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>19791227, :motivo_situao_cadastral=>1, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19780705, :cnae_fiscal_principal=>8888888, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"RUA", :logradouro=>"DO PRADO", :numero=>"S/N", :complemento=>"", :bairro=>"CENTRO", :cep=>58700010, :uf=>"PB", :municipio=>2117, 
# :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>1877367.0, :cnpj_ordem=>1, :cnpj_dv=>50, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>2, :data_situao_cadastral=>20051103, :motivo_situao_cadastral=>0, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19970430, :cnae_fiscal_principal=>4322301, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"RUA", :logradouro=>"BEIJA FLOR", :numero=>390, :complemento=>"", :bairro=>"VILA IGUACUANA", :cep=>26210000, :uf=>"RJ", :municipio=>5869, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>3372832.0, :cnpj_ordem=>1, :cnpj_dv=>27, :identificador_matrizfilial=>1, :nome_fantasia=>"STOP CENTRO AUTOMOTIVO", :situao_cadastral=>2, :data_situao_cadastral=>20050514, :motivo_situao_cadastral=>0, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19990825, :cnae_fiscal_principal=>4530703, :cnae_fiscal_secundria=>"4530705,4520004,4520001,5611203", :tipo_de_logradouro=>"RUA", :logradouro=>"CLINEU DA COSTA MORAES", :numero=>397, :complemento=>"", :bairro=>"JARDIM LEBLON", :cep=>79092060, :uf=>"MS", :municipio=>9051, :ddd_1=>55, :telefone_1=>7864977, :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>55, :fax=>7868545, :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>1877397.0, :cnpj_ordem=>1, :cnpj_dv=>67, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>2, :data_situao_cadastral=>19980728, :motivo_situao_cadastral=>0, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19970605, :cnae_fiscal_principal=>9430800, :cnae_fiscal_secundria=>"9493600,9499500", :tipo_de_logradouro=>"RUA", :logradouro=>"ESTRADA PRINCIPAL", :numero=>"SN", :complemento=>"TERREO", :bairro=>"SAO CRISPIM", :cep=>83860000, :uf=>"PR", :municipio=>7761, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>82990821, :cnpj_ordem=>1, :cnpj_dv=>87, :identificador_matrizfilial=>1, 
# :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>19780502, :motivo_situao_cadastral=>1, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19700311, :cnae_fiscal_principal=>8888888, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"RUA", :logradouro=>"HERCILIO LUZ", :numero=>249, :complemento=>"", :bairro=>"CENTRO", :cep=>88350301, :uf=>"SC", :municipio=>8055, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>57745812, :cnpj_ordem=>1, :cnpj_dv=>83, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>20081231, :motivo_situao_cadastral=>71, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19870713, :cnae_fiscal_principal=>9430800, :cnae_fiscal_secundria=>"9493600,9499500", :tipo_de_logradouro=>"AVENIDA", :logradouro=>"DRACENA", :numero=>755, :complemento=>"", :bairro=>"JAGUARE", :cep=>5329000.0, :uf=>"SP", :municipio=>7107, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>36247351, :cnpj_ordem=>1, :cnpj_dv=>49, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>20081231, :motivo_situao_cadastral=>71, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19900807, :cnae_fiscal_principal=>4781400, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"RUA", :logradouro=>"AMARAL PEIXOTO", :numero=>334, :complemento=>"SALA 116", :bairro=>"CENTRO", :cep=>24140005, :uf=>"RJ", :municipio=>5865, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>68260454, :cnpj_ordem=>1, :cnpj_dv=>35, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>19980531, :motivo_situao_cadastral=>1, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19920715, :cnae_fiscal_principal=>6010100, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"RUA", :logradouro=>"JANUARIO BARBOSA", :numero=>91, :complemento=>"", :bairro=>"CENTRO", :cep=>15850000, :uf=>"SP", :municipio=>7221, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", 
# :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>40909863, :cnpj_ordem=>1, :cnpj_dv=>9.0, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>19960924, :motivo_situao_cadastral=>1, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19910723, :cnae_fiscal_principal=>8888888, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"RUA", :logradouro=>"BARAO DE PENEDO", :numero=>"SN", :complemento=>"ED B P S 1105 11 AD", :bairro=>"CENTRO", :cep=>57020340, :uf=>"AL", :municipio=>2785, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>17125980, :cnpj_ordem=>1, :cnpj_dv=>51, :identificador_matrizfilial=>1, :nome_fantasia=>"DISTRIBUIDORA AGROTECO", :situao_cadastral=>8.0, :data_situao_cadastral=>20150209, :motivo_situao_cadastral=>73, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19711121, :cnae_fiscal_principal=>4789099, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"RUA", :logradouro=>"MENDES PIMENTEL", :numero=>252, :complemento=>"", :bairro=>"CENTRO", :cep=>35290000, :uf=>"MG", :municipio=>4791, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>1653529, :cnpj_ordem=>1, :cnpj_dv=>13, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>20150209, :motivo_situao_cadastral=>73, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>20040505, :cnae_fiscal_principal=>8299799, :cnae_fiscal_secundria=>"6399200,7410299,7490105,7490199,8219999,8299703,8299707", :tipo_de_logradouro=>"RUA", :logradouro=>"MALAKY MURAD", :numero=>177, :complemento=>"", :bairro=>"JD GUADALUPE", :cep=>18076370, :uf=>"SP", :municipio=>7145, :ddd_1=>"", :telefone_1=>"", 
# :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>57746968, :cnpj_ordem=>1, :cnpj_dv=>89, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>20081231, :motivo_situao_cadastral=>71, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19870608, :cnae_fiscal_principal=>8888888, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"RUA", :logradouro=>"BAR DE TATUI", :numero=>335, :complemento=>"CONJ 51", :bairro=>"SANTA CECILIA", :cep=>338968, :uf=>"SP", :municipio=>7107, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>82994724, :cnpj_ordem=>1, :cnpj_dv=>62, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>19941103, :motivo_situao_cadastral=>1, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19910405, :cnae_fiscal_principal=>8888888, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"RUA", :logradouro=>"PERNAMBUCO", :numero=>968, :complemento=>"D", :bairro=>"SANTO ANTONIO", :cep=>89815060, :uf=>"SC", :municipio=>8081, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>6235484.0, :cnpj_ordem=>1, :cnpj_dv=>34, :identificador_matrizfilial=>1, :nome_fantasia=>"REFORMADORA ASTRA", :situao_cadastral=>4, :data_situao_cadastral=>20181018, :motivo_situao_cadastral=>63, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>20040428, :cnae_fiscal_principal=>4520001, :cnae_fiscal_secundria=>"4520002,4520003,4520004", :tipo_de_logradouro=>"RUA", :logradouro=>"JOAO LUIZ", :numero=>"SN", :complemento=>"QD 08 LT 03", :bairro=>"SETOR SANTA RITA", :cep=>74370580, :uf=>"GO", :municipio=>9373, :ddd_1=>62, :telefone_1=>2586246, :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>62, :fax=>2586246, :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>107421, :cnpj_ordem=>1, :cnpj_dv=>90, :identificador_matrizfilial=>1, :nome_fantasia=>"EDIFICIO DOS DEZ", :situao_cadastral=>2, 
# :data_situao_cadastral=>20051103, :motivo_situao_cadastral=>0, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19941108, :cnae_fiscal_principal=>8112500, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"RUA", :logradouro=>"SANTA CLARA", :numero=>248, :complemento=>"", :bairro=>"COPACABANA", :cep=>22041012, :uf=>"RJ", :municipio=>6001, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>4917017.0, :cnpj_ordem=>1, :cnpj_dv=>69, :identificador_matrizfilial=>1, :nome_fantasia=>"MERCADINHO SALES", :situao_cadastral=>8.0, :data_situao_cadastral=>20060825, :motivo_situao_cadastral=>1, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>20020225, :cnae_fiscal_principal=>4712100, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"QUADRA", :logradouro=>117, :numero=>"SN", :complemento=>"LOTE 17", :bairro=>"JARDIM LAGO AZUL", :cep=>72865401, :uf=>"GO", :municipio=>1058, :ddd_1=>49, :telefone_1=>6214305, :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>8061755.0, :cnpj_ordem=>1, :cnpj_dv=>8.0, :identificador_matrizfilial=>1, :nome_fantasia=>"HIPNOSYS VIDEO", :situao_cadastral=>4, :data_situao_cadastral=>20190115, :motivo_situao_cadastral=>63, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>20060405, :cnae_fiscal_principal=>7722500, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"RUA", :logradouro=>"BARRA MANSA", :numero=>186, :complemento=>"CX 6", :bairro=>"JAPUIBA", :cep=>23932665, :uf=>"RJ", :municipio=>5801, :ddd_1=>24, :telefone_1=>33656276, :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>22394399, :cnpj_ordem=>1, :cnpj_dv=>75, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>19921214, :motivo_situao_cadastral=>1, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19861030, :cnae_fiscal_principal=>8888888, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"FAZENDA", :logradouro=>"OLHO D AGUA", :numero=>"SN", :complemento=>"", :bairro=>"ZONA RURAL", :cep=>37138000, :uf=>"MG", :municipio=>4503, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>4917410.0, :cnpj_ordem=>1, :cnpj_dv=>52, :identificador_matrizfilial=>1, :nome_fantasia=>"SH MODAS", :situao_cadastral=>8.0, :data_situao_cadastral=>20070508, :motivo_situao_cadastral=>1, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>20020226, :cnae_fiscal_principal=>4781400, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"AVENIDA", :logradouro=>"JOSE MESSIAS FERREIRA", :numero=>1.863, :complemento=>"", :bairro=>"CENTRO", :cep=>75660000, :uf=>"GO", :municipio=>9277, :ddd_1=>52, :telefone_1=>34441233, 
# :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>52, :fax=>34441233, :correio_eletronico=>"delmar@netmaxi.com.br", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>6623095.0, :cnpj_ordem=>1, :cnpj_dv=>86, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>20041231, :motivo_situao_cadastral=>1, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>20040719, :cnae_fiscal_principal=>9492800, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"FAZENDA", :logradouro=>"SAO JOAO DO AMPARO", :numero=>0, :complemento=>"ZONA RURAL", :bairro=>"", :cep=>76152000, :uf=>"GO", :municipio=>51, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>1779278, :cnpj_ordem=>1, :cnpj_dv=>63, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>20041231, :motivo_situao_cadastral=>1, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>20040719, :cnae_fiscal_principal=>9492800, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"RUA", :logradouro=>"SANTOS DUMONT", :numero=>156, :complemento=>"CASA", :bairro=>"ARNO SIEVERDT", :cep=>89172000, :uf=>"SC", :municipio=>8269, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>36249977, :cnpj_ordem=>1, :cnpj_dv=>94, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>4, :data_situao_cadastral=>20181011, :motivo_situao_cadastral=>63, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19900807, :cnae_fiscal_principal=>1412601, :cnae_fiscal_secundria=>1412603, :tipo_de_logradouro=>"ESTRADA", :logradouro=>"PORTELA", :numero=>294, :complemento=>"SOBRELOJA", :bairro=>"MADUREIRA", :cep=>21351050, :uf=>"RJ", :municipio=>6001, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>2169641.0, :cnpj_ordem=>1, :cnpj_dv=>8.0, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>19980930, 
# :motivo_situao_cadastral=>1, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19971002, :cnae_fiscal_principal=>4774100, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"AVENIDA", :logradouro=>"RIO BRANCO", :numero=>329, :complemento=>"", :bairro=>"SEDE", :cep=>37650000, :uf=>"MG", :municipio=>4209, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>3373190.0, :cnpj_ordem=>1, :cnpj_dv=>80, :identificador_matrizfilial=>1, :nome_fantasia=>"DEDETIZADORA IMUNILAGOS", :situao_cadastral=>2, :data_situao_cadastral=>20051103, :motivo_situao_cadastral=>0, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19990803, :cnae_fiscal_principal=>8122200, :cnae_fiscal_secundria=>"4744003,4742300,4789005", :tipo_de_logradouro=>"RUA", :logradouro=>"ANTONIO DE OLIVEIRA GAMA", :numero=>202, :complemento=>"", :bairro=>"PARQUE ITAJURU", :cep=>28910450, :uf=>"RJ", :municipio=>5813, :ddd_1=>22, :telefone_1=>26450553, :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>6235659.0, :cnpj_ordem=>1, :cnpj_dv=>3, :identificador_matrizfilial=>1, :nome_fantasia=>"SALINA PROTECAO DE DEUS", :situao_cadastral=>8.0, :data_situao_cadastral=>20081231, :motivo_situao_cadastral=>71, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19740529, :cnae_fiscal_principal=>892401.0, :cnae_fiscal_secundria=>990403.0, :tipo_de_logradouro=>"", :logradouro=>"PR SANTA CLARA", :numero=>"SN", :complemento=>"", :bairro=>"SANTA CLARA", :cep=>65180000, :uf=>"MA", :municipio=>797.0, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>54942461, :cnpj_ordem=>1, :cnpj_dv=>2, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>19860611, :motivo_situao_cadastral=>1, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19850930, :cnae_fiscal_principal=>8888888, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"RUA", :logradouro=>"GENERAL OSORIO", :numero=>76, :complemento=>"", :bairro=>"SANTA PAULA", :cep=>9541320.0, :uf=>"SP", :municipio=>7077, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>77488237, :cnpj_ordem=>1, :cnpj_dv=>98, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>2, :data_situao_cadastral=>20021228, :motivo_situao_cadastral=>0, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19770829, :cnae_fiscal_principal=>4771701, :cnae_fiscal_secundria=>4773300, :tipo_de_logradouro=>"RUA", :logradouro=>"BALDUINO TAQUES", :numero=>924, :complemento=>"", :bairro=>"CENTRO", :cep=>84010050, :uf=>"PR", :municipio=>7777, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", 
# :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>8061900.0, :cnpj_ordem=>1, :cnpj_dv=>50, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>2, :data_situao_cadastral=>20060525, :motivo_situao_cadastral=>0, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>20060525, :cnae_fiscal_principal=>9430800, :cnae_fiscal_secundria=>"9493600,9499500", :tipo_de_logradouro=>"SÍTIO", :logradouro=>"ANGICO", :numero=>"S/N", :complemento=>"", :bairro=>"ZONA RURAL", :cep=>63610000, :uf=>"CE", :municipio=>1471, :ddd_1=>88, :telefone_1=>5381177, :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""},{:cnpj_basico=>83003137, :cnpj_ordem=>1, :cnpj_dv=>27, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>19910412, :motivo_situao_cadastral=>9.0, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19910412, :cnae_fiscal_principal=>3230200, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"RUA", :logradouro=>"IRINEU BORNHAUSEN", :numero=>288, :complemento=>"SALA 3", :bairro=>"CENTRO", :cep=>88780000, :uf=>"SC", :municipio=>8143, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""}]
# hash = {:cnpj_basico=>107225, :cnpj_ordem=>1, :cnpj_dv=>23, :identificador_matrizfilial=>1, :nome_fantasia=>"", :situao_cadastral=>8.0, :data_situao_cadastral=>20081231, :motivo_situao_cadastral=>71, :nome_da_cidade_no_exterior=>"", :pais=>"", :data_de_incio_atividade=>19720504, :cnae_fiscal_principal=>4781400, :cnae_fiscal_secundria=>"", :tipo_de_logradouro=>"", :logradouro=>"QNM  09 LOTE", :numero=>27, :complemento=>"CONJ C", :bairro=>"CEILANDIA", :cep=>72237100, :uf=>"DF", :municipio=>9701, :ddd_1=>"", :telefone_1=>"", :ddd_2=>"", :telefone_2=>"", :ddd_do_fax=>"", :fax=>"", :correio_eletronico=>"", :situao_especial=>"", :data_da_situao_especial=>""}


path = "./Data/Estabelecimento100k.csv" # versão reduzida do arquivo original com 100000 linhas.
headers = ["cnpj_basico","cnpj_ordem","cnpj_dv","identificador_matriz/filial","nome_fantasia","situacao_cadastral", "data_situacao_cadastral", "motivo_situacao_cadastral", "nome_cidade_no_exterior","pais", "data_de_inicio_atividade", "cnae_fiscal_principal", "cnae_fiscal_secundaria", "tipo_de_logradouro","logradouro", "numero","complemento" ,"bairro" ,"cep" ,"uf", "municipio", "ddd_1", "telefone_1", "ddd_2", "telefone_2","ddd_do_fax" , "fax","correio_eletronico", "situacao_especial", "data_da_situacao_especial"]
campos_date = [:data_de_inicio_atividade,:data_situacao_cadastral,:data_da_situacao_especial]

chunk = []

client = Mongo::Client.new([ '127.0.0.1:27017' ], :database => 'BenchMark')
db = client.database
collection = client[:chunkTest]
collection.drop()

def converterDatas(hash,campos)
    for campo in campos
        unless (hash[campo].nil? || hash[campo] == "0")
            hash[campo] = Date.strptime(hash[campo].to_s,'%Y%m%d')
        end
    end
end

def clean_hash_chunk(chunk,campos_date) # realiza a remoção dos campos invalidos e chama a função de converter data para a lista de linhas
    clean_hash_chunk = []
    for linha in chunk
        linha = (linha.to_hash).compact # converte a linha em hash e remove os campos invalidos
        linha.reject! { |key, value| value == "" || value == nil || (key == (:data_situacao_cadastral) && (value == "0" || value == 0))}
        converterDatas(linha,campos_date)
        clean_hash_chunk << linha # depois de limpar os campos do hash armazena em uma lista com os novos valores
    end
    return clean_hash_chunk
end

time = Benchmark.measure {
    
    CSV.foreach(path,"rb",liberal_parsing: true,encoding: 'iso-8859-1:utf-8',:headers => headers, :header_converters => :symbol,:col_sep => ";") do |linha|

        chunk << linha
    
        if chunk.size >= 5000 # armazenando a lista de hashes na memoria em chunks de 5000 para tornar o processamento mais rapido
            chunk = clean_hash_chunk(chunk,campos_date)
            collection.insert_many(chunk)
            chunk = []
        end
    end
    collection.insert_many(chunk)

}
puts time.real

# Media de 33 segundos para um arquivo de 100000 linhas